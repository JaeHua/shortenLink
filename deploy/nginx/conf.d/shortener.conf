# http { ... } 或在全局 http 配置里
log_format json_efk escape=json
  '{'
  '"@timestamp":"$time_iso8601",'
  '"host":"$host",'
  '"remote_addr":"$remote_addr",'
  '"xff":"$proxy_add_x_forwarded_for",'
  '"method":"$request_method",'
  '"uri":"$request_uri",'
  '"status":$status,'
  '"body_bytes_sent":$body_bytes_sent,'
  '"referer":"$http_referer",'
  '"user_agent":"$http_user_agent",'
  '"request_time":$request_time,'
  '"upstream_status":"$upstream_status",'
  '"upstream_response_time":"$upstream_response_time"'
  '}';

# deploy/nginx/conf.d/shortener.conf
server {
    listen 80;
    server_name 43.155.103.82;

    access_log /var/log/nginx/shortener.access.log json_efk;
    error_log  /var/log/nginx/shortener.error.log warn;

    # 短域名访问，转发到 show-api
    location / {
        proxy_pass http://show-api:8889;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    # 转链管理入口（可另用管理域名）
    location /convert {
        proxy_pass http://convert-api:8888;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }
}